#!/bin/sh

readf /dev/eeprom0.bootsrc virgin

if [ ${virgin} = 9 ]; then
    echo -n "Hit any key to stop auto firmware update: "
    timeout -a 2
    if [ $? != 0 ]; then
	menutree
    fi

    echo
    echo "FACTORY: START FIRMWARE UPDATE"
    echo
    if [ -z ${global.dhcp.tftp_server_name} ]; then
	dhcp
	if [ $? = 0 ] ; then
	    . /env/bin/yellow_led
	else
	    . /env/bin/red_led
	fi
    fi
    echo
    echo "FACTORY: ERASE NAND FLASH"
    echo
    erase /dev/nand0.work
    if [ $? = 0 ] ; then
	. /env/bin/yellow_led
    else
	echo "FACTORY: ERASE NAND ERROR /dev/nand0.work"
	. /env/bin/red_led
    fi

    echo
    echo "FACTORY: UBIFORMAT NAND FLASH"
    echo
    ubiformat /dev/nand0.work -y
    if [ $? = 0 ] ; then
	. /env/bin/yellow_led
    else
	echo "FACTORY: UBIFORMAT ERROR /dev/nand0.work"
	. /env/bin/red_led
    fi

    echo
    echo "FACTORY: UBIATTACH"
    echo
    if [ -c /dev/nand0.work.ubi ]; then
	ubiattach /dev/nand0.work
	if [ $? = 0 ] ; then
	    . /env/bin/yellow_led
	else
	    echo "FACTORY: UBIATTACH ERROR"
	    . /env/bin/red_led
	fi
    fi

    echo
    echo "FACTORY: UBIMKVOL ROOT0"
    echo
    if [ -c /dev/nand0.work.ubi ]; then
        ubimkvol /dev/nand0.work.ubi root0 0x7000000
	if [ $? = 0 ] ; then
	    . /env/bin/yellow_led
	else
	    echo "FACTORY: UBIMKVOL ROOT0 ERROR"
	    . /env/bin/red_led
	fi
    fi

    echo
    echo "FACTORY: UBIMKVOL ROOT1"
    echo
    if [ -c /dev/nand0.work.ubi ]; then
        ubimkvol /dev/nand0.work.ubi root1 0x7000000
	if [ $? = 0 ] ; then
	    . /env/bin/yellow_led
	else
	    echo "FACTORY: UBIMKVOL ROOT1 ERROR"
	    . /env/bin/red_led
	fi
    fi

    echo
    echo "FACTORY: UBIRELOAD"
    echo
    if [ -c /dev/nand0.work.ubi ]; then
	ubidetach /dev/nand0.work
	ubiattach /dev/nand0.work
	if [ $? = 0 ] ; then
	    . /env/bin/yellow_led
	else
	    echo "FACTORY: UBIREOLAD ERROR"
	    . /env/bin/red_led
	fi
    fi


    echo "FACTORY: UPDATE /dev/nand0.work.ubi.root0"
    tftp ${motherboard.typ}-${motherboard.ver}/root.ubifs /dev/nand0.work.ubi.root0
    if [ $? = 0 ] ; then
	echo "FACTORY: UPDATE ERROR ROOT0"
	. /env/bin/yellow_led
    else
	. /env/bin/red_led
    fi

    echo "FACTORY: UPDATE /dev/nand0.work.ubi.root1"
    tftp ${motherboard.typ}-${motherboard.ver}/root.ubifs /dev/nand0.work.ubi.root1
    if [ $? = 0 ] ; then
	echo "FACTORY: UPDATE ERROR ROOT1"
	. /env/bin/yellow_led
    else
	. /env/bin/red_led
    fi

    echo
    echo "FACTORY: ACTIVATE ROOT0"
    echo
    mw -d /dev/eeprom0.bootsrc -b 0 48
    if [ $? = 0 ] ; then
	. /env/bin/yellow_led
    else
	echo "FACTORY: ACTIVATE ROOT0 ERROR"
	. /env/bin/red_led
    fi

    echo "FACTORY: DONE"
    . /env/bin/yellow_led
    reset
fi
