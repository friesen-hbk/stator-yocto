#!/bin/bash
#
# bootstrap-yocto
#

prepare_git_hooks()
{
mkdir -p .git/hooks
cat > .git/hooks/post-commit << EOF
#!/bin/sh
# Please save this script in .git/hooks/post-commit
# -----------------------------------------------------
# Post-{commit,checkout,merge} hook for the gitinfo2 package
#

# Get the first tag found in the history from the current HEAD
FIRSTTAG=\$(git describe --tags --always --dirty='-*' 2>/dev/null)
# Get the first tag in history that looks like a Release
RELTAG=\$(git describe --tags --long --always --dirty='-*' --match '[0-9]*.*' 2>/dev/null)
GITCOUNT=\$(git rev-list --count HEAD 2>/dev/null)
LASTTAG=$(git describe --tags $(git rev-list --tags --max-count=1))
git --no-pager log -1 --date=short --decorate=short \
--pretty=format:"# DON'T EDIT !!! autogenerated file. DON'T EDIT !!!
HBK_FIRMWARE_HASH = \"%h\"
HBK_FIRMWARE_TAG = \"\$LASTTAG\"
HBK_FIRMWARE_COUNT = \"\$GITCOUNT\"
HBK_FIRMWARE_VERSION = \"\$LASTTAG-\$GITCOUNT-\$BRANCH-\$RELTAG\"
" HEAD > firmware-version.conf
EOF
chmod a+x .git/hooks/post-commit
cp .git/hooks/post-commit .git/hooks/post-checkout
cp .git/hooks/post-commit .git/hooks/post-merge
git checkout
}

prepare_git_hooks || exit 1

echo -e "
    Bootstrapped Yocto/NGT

    Suggested next steps:

    To build card firmware for QEMU:
        MACHINE=qemu source setup-environment build-ngt-qemu
        bitbake hdimage
        bitbake hbg

    To build card firmware for the NGT board:
        MACHINE=ngt-board source setup-environment build-ngt
        bitbake flash
        bitbake hbg

    To build frame firmware for the Atlas-Board:
        MACHINE=atlas-board source setup-environment build-atlas
        bitbake sdimage
"
